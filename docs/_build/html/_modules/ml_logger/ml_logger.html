<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2024.08.06 -->
        <title>ml_dash.ml_dash - ML-Dash</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=362ab14a" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">ML-Dash</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><div class="sidebar-scroll"><a class="sidebar-brand" href="../../index.html">
    
    <div class="sidebar-logo-container" style="margin: .5rem auto .5rem auto">
        <img class="sidebar-logo only-light" src="../../_static/logos/logo_light.png" alt="Light Logo"/>
        <img class="sidebar-logo only-dark" src="../../_static/logos/logo_dark.png" alt="Dark Logo"/>
    </div>
    <!--adding this here-->
    <span class="sidebar-brand-text" style="display: flex; justify-content: space-between; align-items: baseline;">
        <code style="font-size: 2.19em; font-style: bold;
        background-clip: text; color: transparent;
        background-image: linear-gradient(to right, rgb(0,140,220), rgb(226,213,79), rgb(210,0,12))">ML-Dash</code>
        <code style="font-size: 0.7em">v0.1.0</code>
    </span>
    <!--<span class="sidebar-brand-text" style="display: flex">-->
    <!--    <code style="font-size: 1.1em">Documentation</code>-->
    <!--</span>-->
</a>

<div style="padding: 0 18px; display: flex; gap: 0.5em">
    <a class="github-button" href="https://github.com/fortyfive-labs/ml-dash/subscription"
       data-color-scheme="no-preference: light; light: light; dark: dark;" data-size="large" data-show-count="true"
       aria-label="Watch fortyfive-labs/ml-dash on GitHub">Watch</a>
    <a class="github-button" href="https://github.com/fortyfive-labs/ml-dash" data-color-scheme="no-preference: light; light: light; dark: dark;"
       data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star fortyfive-labs/ml-dash on GitHub">Stars</a>
</div>

<script async defer src="https://buttons.github.io/buttons.js"></script><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/fortyfive-labs/ml-dash/issues">Report Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGE_LOG.html">CHANGE LOG</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/ml_dash.html">ml_dash — Core Logger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/types.html">ml_dash.types — Type Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/client.html">ml_dash.client — HTTP Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/cache.html">ml_dash.cache — Local Caching</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for ml_dash.ml_dash</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>

<span class="kn">from</span> <span class="nn">ml_dash.helpers</span> <span class="kn">import</span> <span class="n">load_from_pickle_file</span><span class="p">,</span> <span class="n">load_from_jsonl_file</span>
<span class="kn">from</span> <span class="nn">.caches.key_value_cache</span> <span class="kn">import</span> <span class="n">KeyValueCache</span>
<span class="kn">from</span> <span class="nn">.caches.summary_cache</span> <span class="kn">import</span> <span class="n">SummaryCache</span>
<span class="kn">from</span> <span class="nn">.full_duplex</span> <span class="kn">import</span> <span class="n">Duplex</span>
<span class="kn">from</span> <span class="nn">.helpers.color_helpers</span> <span class="kn">import</span> <span class="n">Color</span>
<span class="kn">from</span> <span class="nn">.helpers.default_set</span> <span class="kn">import</span> <span class="n">DefaultSet</span>
<span class="kn">from</span> <span class="nn">.helpers.print_utils</span> <span class="kn">import</span> <span class="n">PrintHelper</span>
<span class="kn">from</span> <span class="nn">.log_client</span> <span class="kn">import</span> <span class="n">LogClient</span>
<span class="kn">from</span> <span class="nn">.structs</span> <span class="kn">import</span> <span class="n">ALLOWED_TYPES</span>

<span class="c1"># environment defaults</span>
<span class="n">CWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">USER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ML_DASH_USER&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="k">if</span> <span class="n">USER</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># raise a warning during online usage, if the user is not set.</span>
    <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;ML_DASH_USER is not set. This is required for online usage.&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># template for the dashboard url</span>
<span class="n">ML_DASH_URL</span> <span class="o">=</span> <span class="s2">&quot;http://app.dash.ml/</span><span class="si">{prefix}</span><span class="s2">&quot;</span>
<span class="c1"># ML_Dash defaults</span>
<span class="n">ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ML_DASH_ROOT&quot;</span><span class="p">,</span> <span class="n">CWD</span><span class="p">)</span> <span class="ow">or</span> <span class="n">CWD</span>
<span class="n">PREFIX</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ML_DASH_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{USER}</span><span class="s2">/scratch/{now:%Y/%m-</span><span class="si">%d</span><span class="s2">/%H%M%S}&quot;</span><span class="p">)</span>
<span class="n">S3_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ML_DASH_S3_ROOT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">LOGGER_USER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ML_DASH_USER&quot;</span><span class="p">,</span> <span class="n">USER</span><span class="p">)</span>
<span class="n">ACCESS_TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ML_DASH_ACCESS_TOKEN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<div class="viewcode-block" id="pJoin"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.pJoin">[docs]</a><span class="k">def</span> <span class="nf">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">a</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is not idempotent--each call returns a new value. So it has to be a method</span>

<span class="sd">    returns a datetime object if no format string is specified. Otherwise returns a</span>
<span class="sd">    formated string.</span>

<span class="sd">    Each call returns the current time in current timezone</span>

<span class="sd">    :param fmt: formating string, i.e. &quot;%Y-%m-%d-%H-%M-%S-%f&quot;</span>
<span class="sd">    :return: OneOf[datetime, string]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="k">if</span> <span class="n">fmt</span> <span class="k">else</span> <span class="n">now</span>


<span class="k">def</span> <span class="nf">utcnow</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is not idempotent--each call returns a new value. So it has to be a method</span>

<span class="sd">    returns a datetime object if no format string is specified. Otherwise returns a</span>
<span class="sd">    formated string.</span>

<span class="sd">    Each call returns the current time in UTC</span>

<span class="sd">    :param fmt: formating string, i.e. &quot;%Y-%m-%d-%H-%M-%S-%f&quot;</span>
<span class="sd">    :return: OneOf[datetime, string]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="k">if</span> <span class="n">fmt</span> <span class="k">else</span> <span class="n">now</span>


<span class="k">def</span> <span class="nf">metrify</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Help convert non-json serializable objects, such as</span>

<span class="sd">    :param data:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="c1"># todo: add datetime support</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_PrefixContext</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">new_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
    <span class="n">old_metrics_prefix</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">metrics_prefix</span>
    <span class="n">old_prefix</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">prefix</span>

    <span class="k">if</span> <span class="n">new_prefix</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">new_prefix</span>
    <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">metrics_prefix</span> <span class="o">=</span> <span class="n">metrics</span> <span class="o">+</span> <span class="p">(</span><span class="n">sep</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">metrics_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">old_prefix</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">metrics_prefix</span> <span class="o">=</span> <span class="n">old_metrics_prefix</span>


<span class="k">class</span> <span class="nc">Memoize</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_path</span> <span class="o">=</span> <span class="n">c_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pickle</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="o">*</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># todo: use directory for cache key/value pairs</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># remove reference to the function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="kc">None</span>


<span class="c1"># @contextmanager</span>
<span class="c1"># def _LocalContext(logger, new_prefix=None):</span>
<span class="c1">#     old_client = logger.client</span>
<span class="c1">#     logger.prefix = new_prefix</span>
<span class="c1">#     try:</span>
<span class="c1">#         yield</span>
<span class="c1">#     finally:</span>
<span class="c1">#         logger.prefix = old_prefix</span>

<span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>


<span class="c1"># noinspection PyPep8Naming</span>
<div class="viewcode-block" id="ML_Dash"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash">[docs]</a><span class="k">class</span> <span class="nc">ML_Dash</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ML_Dash, a logging utility for ML training.</span>
<span class="sd">    ---</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># is okay b/c strings are immutable in python</span>
    <span class="n">metrics_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">print_buffer</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># move initialization to init.</span>
    <span class="n">print_buffer_size</span> <span class="o">=</span> <span class="mi">2048</span>

    <span class="c1">### Context Helpers</span>
<div class="viewcode-block" id="ML_Dash.Prefix"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.Prefix">[docs]</a>    <span class="k">def</span> <span class="nf">Prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">praefixa</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a context in which the prefix of the logger is set to `prefix`</span>
<span class="sd">        :param praefixa: the new prefix</span>
<span class="sd">        :return: context object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">praefixa</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_PrefixContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_prefix</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_PrefixContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.Sync"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.Sync">[docs]</a>    <span class="k">def</span> <span class="nf">Sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a context in which the logger logs synchronously. The new</span>
<span class="sd">        synchronous request pool is cached on the logging client, so this</span>
<span class="sd">        context can happen repetitively without creating a run-away number</span>
<span class="sd">        of parallel threads.</span>

<span class="sd">        The context object can only be used once b/c it is create through</span>
<span class="sd">        generator using the @contextmanager decorator.</span>

<span class="sd">        :param clean: boolean flag for removing the thead pool after __exit__.</span>
<span class="sd">            used to enforce single-use SyncContexts.</span>
<span class="sd">        :param max_workers: `urllib3` session pool `max_workers` field</span>
<span class="sd">        :return: context object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">SyncContext</span><span class="p">(</span><span class="n">clean</span><span class="o">=</span><span class="n">clean</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.Async"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.Async">[docs]</a>    <span class="k">def</span> <span class="nf">Async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a context in which the logger logs [a]synchronously. The new</span>
<span class="sd">        asynchronous request pool is cached on the logging client, so this</span>
<span class="sd">        context can happen repetitively without creating a run-away number</span>
<span class="sd">        of parallel threads.</span>

<span class="sd">        The context object can only be used once b/c it is create through</span>
<span class="sd">        generator using the @contextmanager decorator.</span>

<span class="sd">        :param clean: boolean flag for removing the thead pool after __exit__.</span>
<span class="sd">            used to enforce single-use AsyncContexts.</span>
<span class="sd">        :param max_workers: `future_sessions.Session` pool `max_workers` field</span>
<span class="sd">        :return: context object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">AsyncContext</span><span class="p">(</span><span class="n">clean</span><span class="o">=</span><span class="n">clean</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="n">PrefixContext</span> <span class="o">=</span> <span class="n">Prefix</span>
    <span class="n">SyncContext</span> <span class="o">=</span> <span class="n">Sync</span>
    <span class="n">AsyncContext</span> <span class="o">=</span> <span class="n">Async</span>

<div class="viewcode-block" id="ML_Dash.memoize"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.memoize">[docs]</a>    <span class="k">def</span> <span class="nf">memoize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="s2">&quot;.cache&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Memoize the function, using current ml-dash root and prefix as hash prefix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>

        <span class="c1"># should also include root.</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ctx</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="n">c_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">hash</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
        <span class="n">c_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">c_prefix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Memoize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.release"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;release the cache corresponding to function f&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>

        <span class="c1"># should also include root.</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>

        <span class="n">c_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">hash</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">ML_Dash</span><span class="p">(</span><span class="s2">&quot;.cache&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c_path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ML_Dash(root=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s1">&quot;,&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s1">&#39;          prefix=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>

    <span class="c1"># noinspection PyInitNewSignature</span>
    <span class="c1"># todo: use prefixes as opposed to prefix. (add *prefixae after prefix=None)</span>
    <span class="c1"># todo: resolve path segment with $env variables.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">prefixae</span><span class="p">,</span>
                 <span class="n">root</span><span class="o">=</span><span class="n">ROOT</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">LOGGER_USER</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="n">ACCESS_TOKEN</span><span class="p">,</span>
                 <span class="n">buffer_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">asynchronous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summary_cache_opts</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; logger constructor.</span>

<span class="sd">        Assumes that you are starting from scratch.</span>

<span class="sd">        | `log_directory` is overloaded to use either</span>
<span class="sd">        | 1. file://some_abs_dir</span>
<span class="sd">        | 2. http://19.2.34.3:8081</span>
<span class="sd">        | 3. /tmp/some_dir</span>
<span class="sd">        |</span>
<span class="sd">        | `prefix` is the log directory relative to the root folder. Absolute path are resolved against the root.</span>
<span class="sd">        | 1. prefix=&quot;causal_infogan&quot; =&gt; logs to &quot;/tmp/some_dir/causal_infogan&quot;</span>
<span class="sd">        | 2. prefix=&quot;&quot; =&gt; logs to &quot;/tmp/some_dir&quot;</span>

<span class="sd">        :param prefix: the prefix path</span>
<span class="sd">        :param *prefixae: the rest of the prefix arguments</span>
<span class="sd">        :param root: the server host and port number</span>
<span class="sd">        :param user: environment $ML_DASH_USER</span>
<span class="sd">        :param access_token: environment $ML_DASH_ACCESS_TOKEN</span>
<span class="sd">        :param asynchronous: When this is not None, we create a http thread pool.</span>
<span class="sd">        :param buffer_size: The string buffer size for the print buffer.</span>
<span class="sd">        :param max_workers: the number of request-session workers for the async http requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.summary_writer = tf.summary.FileWriter(log_directory)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">do_not_print</span> <span class="o">=</span> <span class="n">DefaultSet</span><span class="p">(</span><span class="s2">&quot;__timestamp&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_helper</span> <span class="o">=</span> <span class="n">PrintHelper</span><span class="p">()</span>

        <span class="c1"># init print buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_buffer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer_cache</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_value_caches</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">KeyValueCache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_caches</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">SummaryCache</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">summary_cache_opts</span> <span class="ow">or</span> <span class="p">{})))</span>

        <span class="c1"># todo: add https support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ROOT</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">LogClient</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
                                <span class="n">asynchronous</span><span class="o">=</span><span class="n">asynchronous</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span>

        <span class="n">prefixae</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpolate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">prefixae</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">prefixae</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">prefixae</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">local_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">PREFIX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">USER</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

<div class="viewcode-block" id="ML_Dash.configure"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">prefix</span><span class="o">=</span><span class="n">PREFIX</span><span class="p">,</span>
                  <span class="o">*</span><span class="n">prefixae</span><span class="p">,</span>
                  <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">access_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">asynchronous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">max_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">buffer_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">summary_cache_opts</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">register_experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure an existing logger with updated configurations.</span>

<span class="sd">        # LogClient Behavior</span>

<span class="sd">        The logger.client would be re-constructed if</span>

<span class="sd">            - root_dir is changed</span>
<span class="sd">            - max_workers is not None</span>
<span class="sd">            - asynchronous is not None</span>

<span class="sd">        Because the http LogClient contains http thread pools, one shouldn&#39;t call this</span>
<span class="sd">        configure function in a loop. Instead, use the logger.(A)syncContext() contexts.</span>
<span class="sd">        That context caches the pool so that you don&#39;t create new thread pools again and</span>
<span class="sd">        again.</span>

<span class="sd">        # Cache Behavior</span>

<span class="sd">        Both key-value cache and the summary cache would be cleared if summary_cache_opts</span>
<span class="sd">        is set to not None. A new summary cache would be created, whereas the old</span>
<span class="sd">        key-value cache would be cleared.</span>

<span class="sd">        # Print Buffer Behavior</span>
<span class="sd">        If configure is called with a buffer_size not None, the old print buffer would</span>
<span class="sd">        be cleared.</span>

<span class="sd">        todo: I&#39;m considering also clearing this buffer also when summary-cache is updated.</span>
<span class="sd">        The use-case of changing print_buffer_size is pretty small. Should probaly</span>
<span class="sd">        just deprecate this.</span>

<span class="sd">        # Registering New Experiment</span>

<span class="sd">        This is a convinient default for new users. It prints out a dashboard link to</span>
<span class="sd">        the dashboard url.</span>

<span class="sd">        todo: the table at the moment seems a bit verbose. I&#39;m considering making this</span>
<span class="sd">          just a single line print.</span>

<span class="sd">        :param prefix: the first prefix</span>
<span class="sd">        :param *prefixae: a list of prefix segments</span>
<span class="sd">        :param root:</span>
<span class="sd">        :param user:</span>
<span class="sd">        :param access_token:</span>
<span class="sd">        :param buffer_size:</span>
<span class="sd">        :param summary_cache_opts:</span>
<span class="sd">        :param asynchronous:</span>
<span class="sd">        :param max_workers:</span>
<span class="sd">        :param register_experiment:</span>
<span class="sd">        :param silent: bool, True to turn off the print.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># path logic</span>
        <span class="n">prefixae</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpolate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">prefixae</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">prefixae</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">prefixae</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">USER</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">buffer_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_buffer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">summary_cache_opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_value_caches</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary_caches</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary_caches</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">SummaryCache</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">summary_cache_opts</span> <span class="ow">or</span> <span class="p">{})))</span>

        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ROOT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">or</span> <span class="n">asynchronous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># note: logger.configure shouldn&#39;t be called too often. To quickly switch back</span>
            <span class="c1">#  and forth between synchronous and asynchronous calls, use the `SyncContext`</span>
            <span class="c1">#  and `AsyncContext` instead.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;creating new logging client...&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
                                 <span class="n">asynchronous</span><span class="o">=</span><span class="n">asynchronous</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;✓ created a new logging client&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dashboard: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dash_url</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log_directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># now register the experiment</span>
        <span class="k">if</span> <span class="n">register_experiment</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s2">&quot;register_experiment is now set to None, and will be deprecated in the &quot;</span>
                                     <span class="s2">&quot;next version. - Ge&quot;</span><span class="p">)</span></div>
        <span class="c1">#     with logger.SyncContext(clean=True):  # single use SyncContext</span>
        <span class="c1">#         self.job_running(silent=silent)</span>

<div class="viewcode-block" id="ML_Dash.get_dash_url"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.get_dash_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_dash_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">hydrated</span> <span class="o">=</span> <span class="n">ML_DASH_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hydrated</span> <span class="o">=</span> <span class="n">ML_DASH_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hydrated</span></div>

<div class="viewcode-block" id="ML_Dash.fn_info"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.fn_info">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fn_info</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        logs information of the caller&#39;s stack (module, filename etc)</span>

<span class="sd">        :param fn:</span>
<span class="sd">        :return: info = dict(</span>
<span class="sd">                            name=_[&#39;__name__&#39;],</span>
<span class="sd">                            doc=_[&#39;__doc__&#39;],</span>
<span class="sd">                            module=_[&#39;__module__&#39;],</span>
<span class="sd">                            file=_[&#39;__globals__&#39;][&#39;__file__&#39;]</span>
<span class="sd">                            )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
        <span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getmembers</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">):</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">__wrapped__</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">partial</span><span class="p">):</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">func</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">getmembers</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="n">doc_string</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s1">&#39;__doc__&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">doc_string</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">46</span><span class="p">:</span>
            <span class="n">doc_string</span> <span class="o">=</span> <span class="n">doc_string</span><span class="p">[:</span><span class="mi">46</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; ...&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">_</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc_string</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">_</span><span class="p">[</span><span class="s1">&#39;__module__&#39;</span><span class="p">],</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">_</span><span class="p">[</span><span class="s1">&#39;__globals__&#39;</span><span class="p">][</span><span class="s1">&#39;__file__&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">info</span></div>

<div class="viewcode-block" id="ML_Dash.rev_info"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.rev_info">[docs]</a>    <span class="k">def</span> <span class="nf">rev_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__head__</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_branch__</span><span class="p">)</span></div>

    <span class="n">counter</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="ML_Dash.every"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.every">[docs]</a>    <span class="k">def</span> <span class="nf">every</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">start_on</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns True every n counts. Use the key to count different intervals.</span>

<span class="sd">        Example:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            for i in range(100):</span>
<span class="sd">                if logger.every(10):</span>
<span class="sd">                    print(&#39;every tenth count!&#39;)</span>
<span class="sd">                if logger.every(100, &quot;hudred&quot;):</span>
<span class="sd">                    print(&#39;every 100th count!&#39;)</span>
<span class="sd">                if logger.every(10, &quot;hudred&quot;, start_on=1):</span>
<span class="sd">                    print(&#39;every 10th count starting from the first call: i =&#39;, i)</span>

<span class="sd">        :param n:</span>
<span class="sd">        :param key:</span>
<span class="sd">        :param start_on: start on this call. Use `start_on=1` for tail mode [0, 10, 20] instead of [9, 19, ...]</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_on</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_on</span></div>

<div class="viewcode-block" id="ML_Dash.count"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="ML_Dash.clear"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="ML_Dash.start"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        starts a timer, saved in float in seconds. The returned perf_counter does not have meaning</span>
<span class="sd">        on its own. Only differences between two perf_counters make sense as time delta.</span>

<span class="sd">        Automatically de-dupes the keys, but will return the same number of intervals. duplicates</span>
<span class="sd">        will receive the same result.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            from ml_dash import logger</span>

<span class="sd">            logger.start(&#39;loop&#39;, &#39;iter&#39;)</span>
<span class="sd">            it = 0</span>
<span class="sd">            for i in range(10):</span>
<span class="sd">                it += logger.split(&#39;iter&#39;)</span>
<span class="sd">            print(&#39;iteration&#39;, it / 10)</span>
<span class="sd">            print(&#39;loop&#39;, logger.since(&#39;loop&#39;))</span>

<span class="sd">        :param *keys: position arguments are timed together.</span>
<span class="sd">        :return: float (in seconds)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
        <span class="n">new_tic</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_tic</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_cache</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">timer_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span></div>

<div class="viewcode-block" id="ML_Dash.since"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.since">[docs]</a>    <span class="k">def</span> <span class="nf">since</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns a float in seconds when 1 key is passed, or a list of floats when multiple</span>
<span class="sd">        keys are passed in. The returned value are in seconds, measured by delta in perf_counter.</span>

<span class="sd">        Automatically de-dupes the keys, but will return the same number of intervals. duplicates</span>
<span class="sd">         will receive the same result.</span>

<span class="sd">        Note: This *is* idempotent.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            from ml_dash import logger</span>

<span class="sd">            logger.start(&#39;loop&#39;, &#39;iter&#39;)</span>
<span class="sd">            it = 0</span>
<span class="sd">            for i in range(10):</span>
<span class="sd">                it += logger.split(&#39;iter&#39;)</span>
<span class="sd">            print(&#39;iteration&#39;, it / 10)</span>
<span class="sd">            print(&#39;loop&#39;, logger.since(&#39;loop&#39;))</span>

<span class="sd">        :param *keys: position arguments are timed together.</span>
<span class="sd">        :return: float (in seconds)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="n">tick</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">tick</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># not sure if setting an empty cache is good</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timer_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tick</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> \
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span></div>

    <span class="c1"># timing functions</span>
<div class="viewcode-block" id="ML_Dash.split"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns a float in seconds when 1 key is passed, or a list of floats when multiple keys are</span>
<span class="sd">        passed-in.</span>

<span class="sd">        Automatically de-dupes the keys, but will return the same number of intervals. duplicates</span>
<span class="sd">        will receive the same result.</span>

<span class="sd">        Note: This is Not idempotent, which is why it is not a property.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            from ml_dash import logger</span>

<span class="sd">            logger.split(&#39;loop&#39;, &#39;iter&#39;)</span>
<span class="sd">            it = 0</span>
<span class="sd">            for i in range(10):</span>
<span class="sd">                it += logger.split(&#39;iter&#39;)</span>
<span class="sd">            print(&#39;iteration&#39;, it / 10)</span>
<span class="sd">            print(&#39;loop&#39;, logger.split(&#39;loop&#39;))</span>

<span class="sd">        :param *keys: position arguments are timed together.</span>
<span class="sd">        :return: float (in seconds)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="n">new_tic</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_tic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_tic</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span></div>

<div class="viewcode-block" id="ML_Dash.time"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.time">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{delta:0.3E}</span><span class="s2">s&quot;</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">original</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;time.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">yield</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">):</span>
            <span class="n">stdout_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;timing &lt;</span><span class="si">{</span><span class="n">original</span><span class="si">}</span><span class="s2">&gt;: &quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_caches</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
                <span class="n">stdout_str</span> <span class="o">+=</span> <span class="n">fmt</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stdout_str</span> <span class="o">+=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">stdout_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;±</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">0.1E</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">stdout_str</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.now"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.now">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">now</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">now</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.utcnow"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.utcnow">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">utcnow</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">utcnow</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.truncate"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.truncate">[docs]</a>    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">depth</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        truncates the path&#39;s parent directories w.r.t. given depth. By default, returns the filename</span>
<span class="sd">        of the path.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            path = &quot;/Users/geyang/some-proj/experiments/rope-cnn.py&quot;</span>
<span class="sd">            logger.truncate(path, -1)</span>

<span class="sd">        ::</span>

<span class="sd">            &quot;rope-cnn.py&quot;</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            logger.truncate(path, 4)</span>

<span class="sd">        ::</span>

<span class="sd">            &quot;experiments/rope-cnn.py&quot;</span>

<span class="sd">        This is useful for saving the *relative* path of your main script.</span>

<span class="sd">        :param path: &quot;learning-to-learn/experiments/run.py&quot;</span>
<span class="sd">        :param depth: 1, 2... when 1 it picks only the file name.</span>
<span class="sd">        :return: &quot;run&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="n">depth</span><span class="p">:])</span></div>

<div class="viewcode-block" id="ML_Dash.stem"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.stem">[docs]</a>    <span class="k">def</span> <span class="nf">stem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the stem of the filename in the path, removes the extension</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            path = &quot;/Users/geyang/some-proj/experiments/rope-cnn.py&quot;</span>
<span class="sd">            logger.stem(path)</span>

<span class="sd">        returns:</span>
<span class="sd">        ::</span>

<span class="sd">            &quot;/Users/geyang/some-proj/experiments/rope-cnn&quot;</span>

<span class="sd">        You can use this in combination with the truncate function.</span>
<span class="sd">        .. code:: python</span>

<span class="sd">            _ = logger.truncate(path, 4)</span>
<span class="sd">            _ = logger.stem(_)</span>

<span class="sd">        ::</span>

<span class="sd">            &quot;experiments/rope-cnn&quot;</span>

<span class="sd">        This is useful for saving the *relative* path of your main script.</span>

<span class="sd">        :param path: &quot;learning-to-learn/experiments/run.py&quot;</span>
<span class="sd">        :return: &quot;run&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ML_Dash.diff"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.diff">[docs]</a>    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff_directory</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">diff_filename</span><span class="o">=</span><span class="s2">&quot;index.diff&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        example usage:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            from ml_dash import logger</span>

<span class="sd">            logger.diff()  # =&gt; this writes a diff file to the root of your logging directory.</span>

<span class="sd">        :param ref: the ref w.r.t which you want to diff against. Default to HEAD</span>
<span class="sd">        :param diff_directory: The root directory to call `git diff`, default to current directory.</span>
<span class="sd">        :param diff_filename: The file key for saving the diff file.</span>
<span class="sd">        :param verbose: if True, print out the command.</span>

<span class="sd">        :return: string containing the content of the patch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;cd &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">diff_directory</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; &amp;&amp; git diff </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s1"> --binary&#39;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_line</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Save git diff to experiment directory</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_text</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">diff_filename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">patch</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_line</span><span class="p">(</span><span class="s2">&quot;not storing the git diff due to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__status__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        example usage:</span>
<span class="sd">        --------------</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            from ml_dash import logger</span>

<span class="sd">            diff = logger.__status__  # =&gt; this writes a diff file to the root of your logging directory.</span>

<span class="sd">        :return: the diff string for the current git repo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;cd &quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&quot; &amp;&amp; git status -vv&#39;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Save git diff to experiment directory</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__current_branch__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;git symbolic-ref HEAD&#39;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Save git diff to experiment directory</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__head__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns the git revision hash of the head if inside a git repository&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">git_rev</span><span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ML_Dash.git_rev"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.git_rev">[docs]</a>    <span class="k">def</span> <span class="nf">git_rev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function **used by `logger.__head__`** that returns the git revision hash of the</span>
<span class="sd">        branch that you pass in.</span>

<span class="sd">        full reference here: https://stackoverflow.com/a/949391</span>
<span class="sd">        the `show-ref` and the `for-each-ref` commands both show a list of refs. We only need to get the</span>
<span class="sd">        ref hash for the revision, not the entire branch of by tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="n">branch</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__tags__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">git_tags</span><span class="p">()</span>

<div class="viewcode-block" id="ML_Dash.git_tags"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.git_tags">[docs]</a>    <span class="k">def</span> <span class="nf">git_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;describe&quot;</span><span class="p">,</span> <span class="s2">&quot;--tags&quot;</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>  <span class="c1"># Save git diff to experiment directory</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ML_Dash.diff_file"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.diff_file">[docs]</a>    <span class="k">def</span> <span class="nf">diff_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># job host helper files</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">slurm_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SLURM_JOB_ID&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_preempted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">requests</span>
        <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://169.254.169.254/latest/meta-data/spot/termination-time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;hostname -f&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Save git diff to experiment directory</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_line</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;can not get obtain hostname via `</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">` due to exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># job life-cycle methods</span>
<div class="viewcode-block" id="ML_Dash.job_created"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.job_created">[docs]</a>    <span class="k">def</span> <span class="nf">job_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="n">createTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.job_requested"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.job_requested">[docs]</a>    <span class="k">def</span> <span class="nf">job_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;requested&#39;</span><span class="p">,</span> <span class="n">requestTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.job_started"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.job_started">[docs]</a>    <span class="k">def</span> <span class="nf">job_started</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;started&#39;</span><span class="p">,</span> <span class="n">startTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.job_running"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.job_running">[docs]</a>    <span class="k">def</span> <span class="nf">job_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># todo: this is called as a ping-home.</span>
        <span class="c1"># todo: resolve race between multiple workers. Use hostname/job_id</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;running&#39;</span><span class="p">,</span> <span class="n">runTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.job_paused"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.job_paused">[docs]</a>    <span class="k">def</span> <span class="nf">job_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;paused&#39;</span><span class="p">,</span> <span class="n">pauseTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.job_completed"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.job_completed">[docs]</a>    <span class="k">def</span> <span class="nf">job_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="n">completionTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.job_errored"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.job_errored">[docs]</a>    <span class="k">def</span> <span class="nf">job_errored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">job</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;errored&#39;</span><span class="p">,</span> <span class="n">errorTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.ping"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.ping">[docs]</a>    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;running&#39;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pings the instrumentation server to stay alive. Gets a control signal in return.</span>
<span class="sd">        The background thread is responsible for making the call . This method just returns the buffered</span>
<span class="sd">        signal synchronously.</span>

<span class="sd">        :return: tuple signals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplex</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">thunk</span><span class="p">(</span><span class="o">*</span><span class="n">statuses</span><span class="p">):</span>
                <span class="k">nonlocal</span> <span class="bp">self</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">statuses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">statuses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">Duplex</span><span class="p">(</span><span class="n">thunk</span><span class="p">,</span> <span class="n">interval</span> <span class="ow">or</span> <span class="mi">120</span><span class="p">)</span>  <span class="c1"># default interval is two minutes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duplex</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interval</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duplex</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="n">interval</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplex</span><span class="o">.</span><span class="n">read_buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplex</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buffer</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="c1"># todo: wait for logger to finish upload in async mode.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="ML_Dash.remove"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        removes files and folders by path</span>

<span class="sd">        :param path:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">found_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">found_paths</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">else</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">found_paths</span><span class="p">:</span>
            <span class="n">abs_path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">found_paths</span></div>

<div class="viewcode-block" id="ML_Dash.glob_s3"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.glob_s3">[docs]</a>    <span class="k">def</span> <span class="nf">glob_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_keys</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">KWargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does not support wildcard or pagination, but we could add it in the future.</span>

<span class="sd">        :param query:</span>
<span class="sd">        :param wd:</span>
<span class="sd">        :param max_keys: default is 1000 as in boto3</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">boto3</span>
        <span class="kn">from</span> <span class="nn">wcmatch</span> <span class="kn">import</span> <span class="n">glob</span>

        <span class="k">if</span> <span class="n">wd</span><span class="p">:</span>
            <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">work_prefix</span> <span class="o">=</span> <span class="n">wd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">query_prefix</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">query_prefix</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="n">other</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="n">s3_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_prefix</span> <span class="o">+</span> <span class="n">query_prefix</span><span class="p">)</span>
            <span class="n">work_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">query_prefix</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">s3_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_prefix</span><span class="p">)</span>
            <span class="n">work_prefix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">query_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_prefix</span><span class="p">)</span>
        <span class="n">truncate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">work_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">work_prefix</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
        <span class="c1"># list_objects_v2 supports pagination. -- Ge</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">s3_client</span><span class="o">.</span><span class="n">list_objects</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">=</span><span class="n">s3_prefix</span><span class="p">,</span>
                                          <span class="n">MaxKeys</span><span class="o">=</span><span class="n">max_keys</span><span class="p">,</span> <span class="o">**</span><span class="n">KWargs</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Contents&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">][</span><span class="n">truncate</span><span class="p">:]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">query_prefix</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">globmatch</span><span class="p">(</span><span class="n">query_prefix</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">query_prefix</span><span class="p">):</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">files</span></div>

<div class="viewcode-block" id="ML_Dash.glob_gs"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.glob_gs">[docs]</a>    <span class="k">def</span> <span class="nf">glob_gs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does not support wildcard or pagination, but we could add it in the future.</span>

<span class="sd">        :param query:</span>
<span class="sd">        :param wd:</span>
<span class="sd">        :param max_keys: default is 1000 as in boto3</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">storage</span>

        <span class="k">assert</span> <span class="s2">&quot;*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;glob_gs does not support wildcard.&quot;</span>

        <span class="k">if</span> <span class="n">wd</span><span class="p">:</span>
            <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">work_prefix</span> <span class="o">=</span> <span class="n">wd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">query_prefix</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">query_prefix</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="n">other</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="n">gs_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_prefix</span> <span class="o">+</span> <span class="n">query_prefix</span><span class="p">)</span>
            <span class="n">work_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">query_prefix</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">gs_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_prefix</span><span class="p">)</span>
            <span class="n">work_prefix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">query_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_prefix</span><span class="p">)</span>
        <span class="n">truncate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">work_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">work_prefix</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">gs_client</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
        <span class="c1"># list_objects_v2 supports pagination. -- Ge</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">gs_client</span><span class="o">.</span><span class="n">list_blobs</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">gs_prefix</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="n">max_results</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">truncate</span><span class="p">:]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">query_prefix</span><span class="p">):</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span></div>

<div class="viewcode-block" id="ML_Dash.move"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="n">abs_source</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="n">abs_target</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">abs_source</span><span class="p">,</span> <span class="n">abs_target</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.duplicate"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.duplicate">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">exists_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_symlink</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">abs_source</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="n">abs_target</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">duplicate</span><span class="p">(</span><span class="n">abs_source</span><span class="p">,</span> <span class="n">abs_target</span><span class="p">,</span> <span class="n">exists_ok</span><span class="o">=</span><span class="n">exists_ok</span><span class="p">,</span>
                              <span class="n">follow_symlink</span><span class="o">=</span><span class="n">follow_symlink</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="n">symlinks</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.log_params"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log_params">[docs]</a>    <span class="k">def</span> <span class="nf">log_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;parameters.pkl&quot;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log namespaced parameters in a list.</span>

<span class="sd">        Examples:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            logger.log_params(some_namespace=dict(layer=10, learning_rate=0.0001))</span>

<span class="sd">        generates a table that looks like:</span>

<span class="sd">        ::</span>

<span class="sd">            ══════════════════════════════════════════</span>
<span class="sd">               some_namespace</span>
<span class="sd">            ────────────────────┬─────────────────────</span>
<span class="sd">                   layer        │ 10</span>
<span class="sd">               learning_rate    │ 0.0001</span>
<span class="sd">            ════════════════════╧═════════════════════</span>

<span class="sd">        :param path: the file to which we save these parameters</span>
<span class="sd">        :param silent: do not print out</span>
<span class="sd">        :param kwargs: list of key/value pairs, each key representing the name of the namespace,</span>
<span class="sd">                       and the namespace itself.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span> <span class="k">as</span> <span class="n">c</span>
        <span class="n">key_width</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">value_width</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">section_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;═&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">key_width</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;═&#39;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;╧&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;═&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">value_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s1">&#39;{:^</span><span class="si">{}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">key_width</span><span class="p">),</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;─&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">key_width</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;┬&quot;</span> <span class="o">+</span> <span class="s1">&#39;─&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">value_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">section_data</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">):</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section_data</span><span class="p">)</span>
                <span class="n">_kwargs</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrify</span><span class="p">(</span><span class="n">section_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_param_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">section_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">_param_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrify</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Color</span> <span class="k">else</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">value_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{:^</span><span class="si">{}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_width</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;│ &quot;</span> <span class="o">+</span> <span class="s1">&#39;{:&lt;</span><span class="si">{}</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value_string</span><span class="p">,</span> <span class="n">value_width</span><span class="p">))</span>
                <span class="n">_kwargs</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">_param_dict</span>

        <span class="k">if</span> <span class="s2">&quot;n&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;═&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">key_width</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;╧&#39;</span> <span class="o">+</span> <span class="s1">&#39;═&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">value_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># todo: add logging hook</span>
        <span class="c1"># todo: add yml support</span>
        <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_line</span> <span class="k">if</span> <span class="n">silent</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)(</span><span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.save_pkl"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_pkl">[docs]</a>    <span class="k">def</span> <span class="nf">save_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_dill</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save data in pkl format</span>

<span class="sd">        Note: We use dill so that we can save lambda functions but, but we use pure</span>
<span class="sd">            pickle when saving nn.Modules</span>

<span class="sd">        :param data: python data object to be saved</span>
<span class="sd">        :param path: path for the object, relative to the root logging directory.</span>
<span class="sd">        :param append: default to False -- overwrite by default</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_dill</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">dill</span> <span class="k">as</span> <span class="nn">pickle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pickle</span>

        <span class="c1"># Added s3/gs support</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tfile</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">):</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upload_s3</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">path</span>

            <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upload_gs</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">path</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;data.pkl&quot;</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_buffer</span><span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">overwrite</span><span class="o">=</span><span class="ow">not</span> <span class="n">append</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="ML_Dash.log_data"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log_data">[docs]</a>    <span class="k">def</span> <span class="nf">log_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append data to the file located at the path specified.</span>

<span class="sd">        :param data: python data object to be saved</span>
<span class="sd">        :param path: path for the object, relative to the root logging directory.</span>
<span class="sd">        :param overwrite: boolean flag to switch between &#39;appending&#39; mode and &#39;overwrite&#39; mode.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_pkl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="ow">not</span> <span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.log_metrics"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">flush</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_key_values</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param metrics: (mapping) key/values of metrics to be logged. Overwrites previous value if exist.</span>
<span class="sd">        :param cache: optional KeyValueCache object to be passed in</span>
<span class="sd">        :param flush:</span>
<span class="sd">        :param _key_values:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_value_caches</span><span class="p">[</span><span class="n">cache</span><span class="p">]</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">metrics</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">_key_values</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_key_values</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">Prefix</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="n">_prefix</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_prefix</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_prefix</span> <span class="o">+</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_metrics</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.log_key_value"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log_key_value">[docs]</a>    <span class="k">def</span> <span class="nf">log_key_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_value_caches</span><span class="p">[</span><span class="n">cache</span><span class="p">]</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>

    <span class="nd">@property</span>  <span class="c1"># get default cache</span>
    <span class="k">def</span> <span class="nf">summary_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_caches</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>

<div class="viewcode-block" id="ML_Dash.store_key_value"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.store_key_value">[docs]</a>    <span class="k">def</span> <span class="nf">store_key_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        store the key: value awaiting future summary.</span>

<span class="sd">        :param key: str, can be `/` separated.</span>
<span class="sd">        :param value: numerical value</span>
<span class="sd">        :param silent:</span>
<span class="sd">        :param cache: </span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_metrics</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.store_metrics"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.store_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">store_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">key_values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store the metric data (with the default summary cache) for making the summary later.</span>
<span class="sd">        This allows the logging/saving of training metrics asynchronously from the logging.</span>

<span class="sd">        :param * metrics: a mapping of metrics. Will be destructured and appended</span>
<span class="sd">                               to the data store one key/value at a time,</span>
<span class="sd">        :param silent: bool flag for silencing the keys stored in this call.</span>
<span class="sd">        :param cache:</span>
<span class="sd">        :param ** key_values: key/value arguments, each being a metric key / metric value pair.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_caches</span><span class="p">[</span><span class="n">cache</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">key_values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>  <span class="c1"># todo: deprecate this</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_not_print</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">Prefix</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="n">_prefix</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_prefix</span><span class="p">:</span>
                <span class="n">key_values</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_prefix</span> <span class="o">+</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_values</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="o">**</span><span class="n">key_values</span><span class="p">)</span></div>

    <span class="n">store</span> <span class="o">=</span> <span class="n">store_metrics</span>

<div class="viewcode-block" id="ML_Dash.peek_stored_metrics"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.peek_stored_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">peek_stored_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">print_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_caches</span><span class="p">[</span><span class="n">cache</span><span class="p">]</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_helper</span><span class="o">.</span><span class="n">format_row_table</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">do_not_print_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_not_print</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">print</span> <span class="k">if</span> <span class="n">print_only</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_line</span><span class="p">)(</span><span class="n">output</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.log_metrics_summary"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log_metrics_summary">[docs]</a>    <span class="k">def</span> <span class="nf">log_metrics_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_values</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">cache</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key_stats</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">default_stats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_key_modes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        logs the statistical properties of the stored metrics, and clears the</span>
<span class="sd">        `summary_cache` if under `tiled` mode, and keeps the data otherwise</span>
<span class="sd">        (under `rolling` mode).</span>

<span class="sd">        To enable explicit mode without specifying *only_keys, set</span>
<span class="sd">        `get_only` to True</span>

<span class="sd">        Modes for the Statistics:</span>

<span class="sd">        key_mode would be one of:</span>
<span class="sd">          - mean:</span>
<span class="sd">          - min_max:</span>
<span class="sd">          - std_dev:</span>
<span class="sd">          - quantile:</span>
<span class="sd">          - histogram(bins=10):</span>


<span class="sd">        :param key_values: extra key (and values) to log together with summary such as `timestep`, `epoch`, etc.</span>
<span class="sd">        :param cache: (dict) An optional cache object from which the summary is made.</span>
<span class="sd">        :param key_stats: (dict) a dictionary for the key and the statistic modes to be returned.</span>
<span class="sd">        :param default_stats: (one of [&#39;mean&#39;, &#39;min_max&#39;, &#39;std_dev&#39;, &#39;quantile&#39;, &#39;histogram&#39;])</span>
<span class="sd">        :param silent: (bool) a flag to turn the printing On/Off</span>
<span class="sd">        :param flush: (bool) flush the key_value cache if trueful.</span>
<span class="sd">        :param _key_modes: (**) key value pairs, as a short hand for the key_modes dictionary.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_caches</span><span class="p">[</span><span class="n">cache</span><span class="p">]</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">key_stats</span><span class="o">=</span><span class="n">key_stats</span><span class="p">,</span> <span class="n">default_stats</span><span class="o">=</span><span class="n">default_stats</span><span class="p">,</span> <span class="o">**</span><span class="n">_key_modes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_values</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">Prefix</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="n">_prefix</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_prefix</span><span class="p">:</span>
                    <span class="n">key_values</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_prefix</span> <span class="o">+</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_values</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">Prefix</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># todo: use `summary` key to avoid interference with keyvalue metrics.</span>
            <span class="c1">#  self.log_metrics(metrics=summary, silent=silent, flush=flush, cache=&quot;summary&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.log"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_key_values</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        log dictionaries of data, key=value pairs at step == step.</span>

<span class="sd">        logs *argss as line and kwargs as key / value pairs</span>

<span class="sd">        :param args: (str) strings or objects to be printed.</span>
<span class="sd">        :param metrics: (dict) a dictionary of key/value pairs to be saved in the key_value_cache</span>
<span class="sd">        :param sep: (str) separator between the strings in *args</span>
<span class="sd">        :param end: (str) string to use for the end of line. Default to &quot;\n&quot;</span>
<span class="sd">        :param silent: (boolean) whether to also print to stdout or just log to file</span>
<span class="sd">        :param flush: (boolean) whether to flush the text logs</span>
<span class="sd">        :param cache: optional (str) a specific cache key, useful for scoped reporting</span>
<span class="sd">        :param kwargs: key/value arguments</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>  <span class="c1"># do NOT print the &#39;\n&#39; if args is empty in call. Different from the signature of the print function.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_line</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">_key_values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="n">_key_values</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">_prefix</span><span class="o">=</span><span class="n">_prefix</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">)</span></div>

    <span class="n">metric_filename</span> <span class="o">=</span> <span class="s2">&quot;metrics.pkl&quot;</span>
    <span class="n">log_filename</span> <span class="o">=</span> <span class="s2">&quot;outputs.log&quot;</span>

<div class="viewcode-block" id="ML_Dash.flush_metrics"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.flush_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">flush_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">file</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">silent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_value_caches</span><span class="p">[</span><span class="n">cache</span><span class="p">]</span>
        <span class="n">key_values</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">pop_all</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">file</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_filename</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_helper</span><span class="o">.</span><span class="n">format_tabular</span><span class="p">(</span><span class="n">key_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_not_print</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="ow">and</span> <span class="n">output</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># not buffered</span>
        <span class="n">file_key</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jsonl&quot;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">json</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_text</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yml&quot;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">yaml</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_text</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">key_values</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">key_values</span><span class="p">)</span>
        <span class="c1"># fixme: this has caused trouble before.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_not_print</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="ML_Dash.flush"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flushes the key_value cache and the print buffer&quot;&quot;&quot;</span>
        <span class="c1"># self.log_metrics_summary(flush=False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush_metrics</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush_print_buffer</span><span class="p">()</span></div>

<div class="viewcode-block" id="ML_Dash.upload_buffer"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.upload_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">upload_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;UPload a buffer array to the target path (key).</span>

<span class="sd">        Note: the file path (key) has to have the correct extension.</span>

<span class="sd">        The extension and the file encoding are not handled by ML-Dash.</span>

<span class="sd">        Args:</span>
<span class="sd">            buffer ([type]): binary buffer of the content of the file.</span>
<span class="sd">            key ([type]): the intended path for the file to be written to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_buffer</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">full_path</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.upload_file"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.upload_file">[docs]</a>    <span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">target_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;files/&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        uploads a file (through a binary byte string) to a target_folder. Default</span>
<span class="sd">        target is &quot;files&quot;</span>

<span class="sd">        :param file_path: the path to the file to be uploaded</span>
<span class="sd">        :param target_path: the target folder for the file, preserving the filename of the file.</span>
<span class="sd">            if end of `/`, uses the original file name.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">target_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)]</span> <span class="k">if</span> <span class="n">target_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_buffer</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">target_path</span><span class="p">,</span> <span class="o">*</span><span class="n">basename</span><span class="p">),</span> <span class="n">buf</span><span class="o">=</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.upload_dir"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.upload_dir">[docs]</a>    <span class="k">def</span> <span class="nf">upload_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(),</span> <span class="n">archive</span><span class="o">=</span><span class="s1">&#39;tar&#39;</span><span class="p">,</span> <span class="n">temp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        upload dir to gs, s3, and ml-dash.</span>

<span class="sd">        :param dir_path: this is the path to the dir</span>
<span class="sd">        :param target: this is the target location</span>
<span class="sd">        :param excludes: NotImplemented</span>
<span class="sd">        :param archive: is the archive format: one of &quot;zip&quot;, &quot;tar&quot;, &quot;gztar&quot;, &quot;bztar&quot;, or &quot;xztar&quot;.  Or any other</span>
<span class="sd">            registered format.</span>
<span class="sd">        :param temp_dir: NotImplemented, should allow override of temp folder in case storage limits exist.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">tempfile</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">):</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;s3&#39;</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;gs&#39;</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;local&#39;</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;logger&#39;</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">archive</span><span class="p">:</span>
            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">base_name</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                               <span class="nb">format</span><span class="o">=</span><span class="n">archive</span><span class="p">,</span>
                                               <span class="n">root_dir</span><span class="o">=</span><span class="n">dir_path</span><span class="p">,</span>
                                               <span class="n">base_dir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;s3&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">upload_s3</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;gs&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">upload_gs</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Uploading directories is Not Yet Implemented. Specify archive format instead.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.download_dir"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.download_dir">[docs]</a>    <span class="k">def</span> <span class="nf">download_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="s1">&#39;tar&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">pathlib</span>

        <span class="k">if</span> <span class="n">source_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">):</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;s3&#39;</span>
            <span class="n">source_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">source_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;gs&#39;</span>
            <span class="n">source_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">source_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;local&#39;</span>
            <span class="n">source_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">source_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>

        <span class="n">to</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unpack</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;s3&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">download_s3</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">temp_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">source_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;gs&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">download_gs</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">temp_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">source_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">temp_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">source_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">temp_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">source_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="n">shutil</span><span class="o">.</span><span class="n">unpack_archive</span><span class="p">(</span><span class="n">temp_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">source_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">unpack</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;s3&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_s3</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;gs&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_gs</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.remove_s3"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.remove_s3">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_s3</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">boto3</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">))</span></div>

<div class="viewcode-block" id="ML_Dash.remove_gs"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.remove_gs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_gs</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">storage</span>

        <span class="n">storage_client</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">object_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">object_name</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>
        <span class="n">storage_client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">delete_blob</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="ML_Dash.upload_gs"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.upload_gs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">upload_gs</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;file has to be a filename of the string type.&quot;</span>

        <span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">storage</span>

        <span class="n">storage_client</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">object_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">object_name</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="c1"># If path ends with &#39;/&#39; use file_name as the object name</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
            <span class="n">object_name</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="n">storage_client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span><span class="o">.</span><span class="n">upload_from_filename</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="ML_Dash.download_gs"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.download_gs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">download_gs</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">storage</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">object_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">object_name</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>

        <span class="n">storage_client</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span><span class="o">.</span><span class="n">download_to_filename</span><span class="p">(</span><span class="n">to</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.upload_s3"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.upload_s3">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">upload_s3</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload a file to an S3 bucket</span>

<span class="sd">        :param source_path: File name for the file to be uploaded</span>
<span class="sd">        :param path: path to an S3 bucket to upload to</span>
<span class="sd">        :return: True if file was uploaded, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">boto3</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;file has to be a filename of the string type.&quot;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">object_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">object_name</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="c1"># If path ends with &#39;/&#39; use file_name as the object name</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
            <span class="n">object_name</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1"># todo: consider adding exception handling -- good or bad?</span>
        <span class="c1"># Upload the file</span>
        <span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
        <span class="c1"># from botocore.exceptions import ClientError</span>
        <span class="c1"># try:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">)</span>
        <span class="c1"># return response</span>
        <span class="c1"># except ClientError as e:</span>
        <span class="c1">#     return False</span>
        <span class="c1"># return True</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="ML_Dash.download_s3"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.download_s3">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">download_s3</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">boto3</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="o">*</span><span class="n">object_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">object_name</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>

        <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s3</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.save_images"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_images">[docs]</a>    <span class="k">def</span> <span class="nf">save_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">value_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">background</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log images as a composite of a grid. Images input as a 4-D stack.</span>

<span class="sd">        :param stack: Size(n, w, h, c)</span>
<span class="sd">        :param key: the filename for the composite image.</span>
<span class="sd">        :param n_rows: number of rows</span>
<span class="sd">        :param n_cols: number of columns</span>
<span class="sd">        :param cmap: OneOf([str, matplotlib.cm.ColorMap])</span>
<span class="sd">        :param normalize: defaul None. OneOf[None, &#39;individual&#39;, &#39;row&#39;, &#39;column&#39;, &#39;grid&#39;]. Only &#39;grid&#39; and</span>
<span class="sd">                          &#39;individual&#39; are implemented.</span>
<span class="sd">        :param dtype: dtype to use for the saved image.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check dtype is supported by ml-dash</span>
        <span class="k">assert</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">ALLOWED_TYPES</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unsupported dtype: </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">. Supported types: </span><span class="si">{</span><span class="n">ALLOWED_TYPES</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_cols</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="n">n_rows</span> <span class="ow">or</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span>

        <span class="n">value_low</span><span class="p">,</span> <span class="n">value_high</span> <span class="o">=</span> <span class="n">value_range</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">normalize</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;normalization is not applicable to </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> images&quot;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># todo: change to always set shape to len(4), and check if dim[1] is 1.</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
            <span class="n">map_fn</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span> <span class="ow">or</span> <span class="s1">&#39;Greys&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">normalize</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">normalize</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
                    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nammin</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                    <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">normalize</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;individual&#39;</span><span class="p">]:</span>
                    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                    <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">normalize</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;for normalize = </span><span class="si">{</span><span class="n">normalize</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="n">stack</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span> <span class="o">*</span> <span class="p">(</span><span class="n">value_high</span> <span class="o">-</span> <span class="n">value_low</span><span class="p">)</span> <span class="o">+</span> <span class="n">value_low</span>

            <span class="c1"># Clip values after applying cmap</span>
            <span class="n">dtype_max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_fn</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">value_low</span><span class="p">,</span> <span class="n">value_high</span><span class="p">))</span> <span class="o">*</span> <span class="n">dtype_max_val</span><span class="p">)</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;color map is not used for rgb(a) images.&quot;</span>

            <span class="k">if</span> <span class="n">normalize</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">normalize</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
                    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">normalize</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;individual&#39;</span><span class="p">]:</span>
                    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                    <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">normalize</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;for normalize = </span><span class="si">{</span><span class="n">normalize</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="n">stack</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span> <span class="o">*</span> <span class="p">(</span><span class="n">value_high</span> <span class="o">-</span> <span class="n">value_low</span><span class="p">)</span> <span class="o">+</span> <span class="n">value_low</span>

            <span class="c1"># Clip values</span>
            <span class="n">dtype_max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">value_low</span><span class="p">,</span> <span class="n">value_high</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype_max_val</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> is not supported. `len(shape)` should be 3 &quot;</span>
                <span class="s2">&quot;for grayscale, and 4 for RGB(A).&quot;</span>
            <span class="p">)</span>

        <span class="c1"># this needs to be updated</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ALLOWED_TYPES</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;the image type need to be one of </span><span class="si">{</span><span class="n">ALLOWED_TYPES</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># todo: add color background -- need to decide on which library to use.</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">h</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">,</span> <span class="n">w</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">],</span> <span class="n">background</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="n">j</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c1"># todo: remove last index</span>
                <span class="n">composite</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">h</span><span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="n">w</span><span class="p">:</span> <span class="n">j</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">send_image</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">composite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span></div>

<div class="viewcode-block" id="ML_Dash.save_image"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_image">[docs]</a>    <span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log a single image.</span>

<span class="sd">        :param image: numpy object Size(w, h, 3)</span>
<span class="sd">        :param key: example: &quot;figures/some_fig_name.png&quot;, the file key to which the</span>
<span class="sd">            image is saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_images</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.save_video"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_video">[docs]</a>    <span class="k">def</span> <span class="nf">save_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_stack</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="o">**</span><span class="n">imageio_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Let&#39;s do the compression here. Video frames are first written to a temporary file</span>
<span class="sd">        and the file containing the compressed data is sent over as a file buffer.</span>

<span class="sd">        Save a stack of images to</span>

<span class="sd">        :param frame_stack: the stack of video frames</span>
<span class="sd">        :param key: the file key to which the video is logged.</span>
<span class="sd">        :param format: Supports &#39;mp4&#39;, &#39;gif&#39;, &#39;apng&#39; etc.</span>
<span class="sd">        :param imageio_kwargs: (map) optional keyword arguments for `imageio.mimsave`.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">format</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># noinspection PyShadowingBuiltins</span>
            <span class="n">_</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
                <span class="c1"># noinspection PyShadowingBuiltins</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># to remove the dot</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># noinspection PyShadowingBuiltins</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;mp4&quot;</span>
                <span class="n">key</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">format</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">imageio</span>  <span class="c1"># , logging as py_logging</span>
        <span class="c1"># py_logging.getLogger(&quot;imageio&quot;).setLevel(py_logging.WARNING)</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ntp</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">img_as_ubyte</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">imageio</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">img_as_ubyte</span><span class="p">(</span><span class="n">frame_stack</span><span class="p">),</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span> <span class="o">**</span><span class="n">imageio_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">imageio</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">NeedDownloadError</span><span class="p">:</span>
                <span class="n">imageio</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">ffmpeg</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
                <span class="n">imageio</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">img_as_ubyte</span><span class="p">(</span><span class="n">frame_stack</span><span class="p">),</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span> <span class="o">**</span><span class="n">imageio_kwargs</span><span class="p">)</span>
            <span class="n">ntp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_buffer</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.make_video"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.make_video">[docs]</a>    <span class="k">def</span> <span class="nf">make_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;ascending&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">imageio_kwargs</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">wd</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">wd</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">make_video</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="o">**</span><span class="n">imageio_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.make_archive"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.make_archive">[docs]</a>    <span class="k">def</span> <span class="nf">make_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;tar&quot;</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">archive_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make an archive of the files in the current working directory.</span>

<span class="sd">        :param base_name: Do NOT include the suffix &quot;.tar&quot; This should be the root directory that you want to include</span>
<span class="sd">        :param format: One of [&quot;tar&quot;, &quot;zip&quot;, &quot;gztar&quot;, &quot;bztar&quot;, &quot;xztar&quot;]</span>
<span class="sd">        :param root_dir: Should be the same as base_name</span>
<span class="sd">        :param base_dir: Should often be relative and empty.</span>
<span class="sd">        :param archive_kwargs: keyword arguments for shutil.make_archive</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">root_dir</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="n">base_dir</span><span class="p">,</span>
                                        <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="o">**</span><span class="n">archive_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.shell"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.shell">[docs]</a>    <span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        call shell on the remote server</span>

<span class="sd">        :param command:</span>
<span class="sd">        :param wd:</span>
<span class="sd">        :return: stdout, stderr, returncode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wd</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">wd</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">)</span></div>

    <span class="c1"># todo: incremental save pyplot to video.</span>
    <span class="c1"># def VideoContext(self, fig = None)</span>
    <span class="c1">#     yield blah</span>

<div class="viewcode-block" id="ML_Dash.save_pyplot"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_pyplot">[docs]</a>    <span class="k">def</span> <span class="nf">save_pyplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;plot.png&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves matplotlib figure. The interface of this method emulates `matplotlib.pyplot.savefig`</span>
<span class="sd">            method.</span>

<span class="sd">        :param key: (str) file name to which the plot is saved.</span>
<span class="sd">        :param fig: optioanl matplotlib figure object. When omitted just saves the current figure.</span>
<span class="sd">        :param format: One of the output formats [&#39;pdf&#39;, &#39;png&#39;, &#39;svg&#39; etc]. Default to the extension</span>
<span class="sd">            given by the ``key`` argument in :func:`savefig`.</span>
<span class="sd">        :param `**kwargs`: other optional arguments that are passed into</span>
<span class="sd">            _matplotlib.pyplot.savefig: https://matplotlib.org/api/_as_gen/matplotlib.pyplot.savefig.html</span>
<span class="sd">        :return: (str) path to which the figure is saved to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># can not simplify the logic, because we can&#39;t pass the filename to pyplot. A buffer is passed in instead.</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>  <span class="c1"># so allow key with dots in it: metric_plot.text.plot + &quot;.png&quot;. Because user intention is clear</span>
            <span class="n">path</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">format</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># to get rid of the &quot;.&quot; at the begining of &#39;.svg&#39;.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;png&quot;</span>
                <span class="n">path</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">format</span>

        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_buffer</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="ML_Dash.savefig"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.savefig">[docs]</a>    <span class="k">def</span> <span class="nf">savefig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves matplotlib figure. The interface of this method emulates `matplotlib.pyplot.savefig`</span>
<span class="sd">            method.</span>

<span class="sd">        :param key: (str) file name to which the plot is saved.</span>
<span class="sd">        :param fig: optioanl matplotlib figure object. When omitted just saves the current figure.</span>
<span class="sd">        :param format: One of the output formats [&#39;pdf&#39;, &#39;png&#39;, &#39;svg&#39; etc]. Default to the extension</span>
<span class="sd">            given by the ``key`` argument in :func:`savefig`.</span>
<span class="sd">        :param `**kwargs`: other optional arguments that are passed into</span>
<span class="sd">            _matplotlib.pyplot.savefig: https://matplotlib.org/api/_as_gen/matplotlib.pyplot.savefig.html</span>
<span class="sd">        :return: (str) path to which the figure is saved to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_pyplot</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.save_module"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_module">[docs]</a>    <span class="k">def</span> <span class="nf">save_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;weights.pkl&quot;</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save torch module. Overwrites existing file.</span>

<span class="sd">        Now Supports `nn.DataParallel` modules. First</span>
<span class="sd">        try to access the state dict, if not available</span>
<span class="sd">        try the module.module attribute.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            module = nn.DataParallel(lenet)</span>
<span class="sd">            logger.save_module(module, &quot;checkpoint.pk&quot;)</span>

<span class="sd">        When the model is large, this function uploads the weight dictionary (state_dict) in</span>
<span class="sd">        chunks. You can specify the size for the chunks, measured in number of tensors.</span>

<span class="sd">        The conversion convention for the upload chunks is roughly 32bit, or 8 bytes for each</span>
<span class="sd">        `np.float32` entry. so the upload size for chunk = 100,000 is roughly</span>

<span class="sd">            100_000 * 8 * &lt;base56 encoding ration&gt; ~ 960k.</span>

<span class="sd">        :param module: the PyTorch module to be saved.</span>
<span class="sd">        :param path: filename to which we save the module.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo: add</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;state_dict&quot;</span><span class="p">):</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;module&quot;</span><span class="p">):</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;module does not have `.state_dict` attribute or a valid `.module`.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_torch</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="n">tries</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="n">backup</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.read_state_dict"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.read_state_dict">[docs]</a>    <span class="k">def</span> <span class="nf">read_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;weights.pkl&quot;</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">matcher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">all_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path matching </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is not found&quot;</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="n">wd</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_paths</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_torch</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.load_module"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_module">[docs]</a>    <span class="k">def</span> <span class="nf">load_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;weights.pkl&quot;</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">matcher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">map_location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load torch module from file.</span>

<span class="sd">        Now supports:</span>

<span class="sd">        - streaming mode: where multiple segments of the same model is</span>
<span class="sd">            saved as chunks in a pickle file.</span>
<span class="sd">        - partial, or prefixed load with :code:`matcher`.</span>
<span class="sd">        - multiple tires: on unreliable networks (coffee shop!)</span>

<span class="sd">        To manipulate the prefix of a checkpoint file you can do</span>

<span class="sd">        Using Matcher for Partial or Prefixed load</span>

<span class="sd">        Imaging you are trying to load weights from a different module</span>
<span class="sd">        that is missing a prefix for their keys. (For example you</span>
<span class="sd">        have a L2 metric function, and is trying to load from a VAE</span>
<span class="sd">        embedding function baseline (only half of the netowrk)).</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            from ml_dash import logger</span>

<span class="sd">            net = models.ResNet()</span>
<span class="sd">            logger.load_module(</span>
<span class="sd">                   net,</span>
<span class="sd">                   path=&quot;/checkpoint/geyang/resnet.pkl&quot;,</span>
<span class="sd">                   matcher=lambda d, k, p: d[k.replace(&#39;embed.&#39;)])</span>

<span class="sd">        To fill-in if there are missing keys:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            from ml_dash import logger</span>

<span class="sd">            net = models.ResNet()</span>
<span class="sd">            logger.load_module(</span>
<span class="sd">                   net,</span>
<span class="sd">                   path=&quot;/checkpoint/geyang/resnet.pkl&quot;,</span>
<span class="sd">                   matcher=lambda d, k, p: d[k] if k in d else p[k])</span>

<span class="sd">        :param module: target torch module you want to load</span>
<span class="sd">        :param path: the weight file containing the weights</span>
<span class="sd">        :param stream:</span>
<span class="sd">        :param tries:</span>
<span class="sd">        :param matcher: function to remove prefix, repeat keys, partial load (by).</span>
<span class="sd">                    Should take in 2 or three arguments:</span>

<span class="sd">                    .. code:: python</span>

<span class="sd">                        def matcher(checkpoint_dict, key, current_dict):</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_state_dict</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="n">tries</span><span class="p">,</span> <span class="n">matcher</span><span class="o">=</span><span class="n">matcher</span><span class="p">,</span>
                                          <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">state_dict</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;the datafile can not be empty: [state_dict == </span><span class="se">{{</span><span class="si">{</span><span class="n">state_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">...</span><span class="se">}}</span><span class="s2">]&quot;</span>

        <span class="n">module</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.save_variables"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_variables">[docs]</a>    <span class="k">def</span> <span class="nf">save_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;variables.pkl&quot;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save tensorflow variables in a dictionary</span>

<span class="sd">        :param variables: A Tuple (Array) of TensorFlow Variables.</span>
<span class="sd">        :param path: default: &#39;variables.pkl&#39;, filepath to the pkl file, with which we save the variable values.</span>
<span class="sd">        :param namespace: A folder name for the saved variable. Default to `./checkpoints` to keep things organized.</span>
<span class="sd">        :param keys: None or Array(size=len(variables)). When is an array the length has to be the same as that of</span>
<span class="sd">        the list of variables. This parameter allows you to overwrite the key we use to save the variables.</span>

<span class="sd">        By default, we generate the keys from the variable name, without the `:[0-9]` at the end that points to the</span>
<span class="sd">        tensor (from the variable itself).</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo: need to upgrade to the multi-part upload scheme</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">),</span> <span class="s1">&#39;the keys and the variables have to be the same length.&#39;</span>
        <span class="kn">import</span> <span class="nn">tensorflow.compat.v1</span> <span class="k">as</span> <span class="nn">tf</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_session</span><span class="p">()</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">)}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">save_pkl</span><span class="p">(</span><span class="n">weight_dict</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.load_variables"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_variables">[docs]</a>    <span class="k">def</span> <span class="nf">load_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load the saved value from a pickle file into tensorflow variables.</span>

<span class="sd">        The variables that are loaded is the intersection between the tf.global_variables() list and the</span>
<span class="sd">        variables saved in the weight_dict. When a variable in the weight_dict is not present in the</span>
<span class="sd">        current session&#39;s computation graph, no error is reported. When a variable present in the global</span>
<span class="sd">        variables list is not present in the weight_dict, no exception is raised.</span>

<span class="sd">        The variables argument overrides the global variable list. When a variable present in this list doesn&#39;t</span>
<span class="sd">        exist in the weight list, an exception should be raised.</span>

<span class="sd">        :param path: path to the saved checkpoint pickle file.</span>
<span class="sd">        :param variables: None or a list of tensorflow variables. When this list is supplied,</span>
<span class="sd">            every variable&#39;s truncated name has to exist inside the loaded weight_dict.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">tensorflow.compat.v1</span> <span class="k">as</span> <span class="nn">tf</span>
        <span class="n">weight_dict</span><span class="p">,</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_session</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">weight_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">v</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for k, v in weight_dict.items():</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables</span><span class="p">():</span>
                <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">weight_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">v</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.load_text"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_text">[docs]</a>    <span class="k">def</span> <span class="nf">load_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; return the text content of the file (in a single chunk)</span>

<span class="sd">        todo: check handling of line-separated files</span>

<span class="sd">        when key starts with a single slash as in &quot;/debug/some-run&quot;, the leading slash is removed</span>
<span class="sd">        and the remaining path is pathJoin&#39;ed with the data_dir of the server.</span>

<span class="sd">        So if you want to access absolute path of the filesystem that the logging server is in,</span>
<span class="sd">        you should append two leadning slashes. This way, when the leanding slash is removed,</span>
<span class="sd">        the remaining path is still an absolute value and joining with the data_dir would post</span>
<span class="sd">        no effect.</span>

<span class="sd">        &quot;//home/ubuntu/ins-runs/debug/some-other-run&quot; would point to the system absolute path.</span>

<span class="sd">        :param *keys: path string fragments</span>
<span class="sd">        :return: a tuple of each one of the data chunck logged into the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">))</span></div>

<div class="viewcode-block" id="ML_Dash.load_jsonl"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_jsonl">[docs]</a>    <span class="k">def</span> <span class="nf">load_jsonl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                    <span class="n">blobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">blobs</span><span class="p">:</span>
                        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_from_jsonl_file</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># todo: use separate random generator to avoid mutating global random generator.</span>
                <span class="n">sleep</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">delay</span><span class="p">)</span>
                <span class="n">tries</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="c1"># last one does not catch.</span>
        <span class="k">with</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_from_jsonl_file</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span></div>

<div class="viewcode-block" id="ML_Dash.save_torch"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_torch">[docs]</a>    <span class="k">def</span> <span class="nf">save_torch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">torch</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span><span class="p">):</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span>
            <span class="k">return</span> <span class="n">path</span>

        <span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tfile</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">tfile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">):</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upload_s3</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">path</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upload_gs</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">path</span>

            <span class="n">target_path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tries</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">target_path</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">path</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="n">backup</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tries</span><span class="si">}</span><span class="s2"> left, saving to </span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2"> again. Backup for </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> sec...&quot;</span><span class="p">)</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span></div>

    <span class="n">torch_save</span> <span class="o">=</span> <span class="n">save_torch</span>

<div class="viewcode-block" id="ML_Dash.torch_jit_save"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.torch_jit_save">[docs]</a>    <span class="k">def</span> <span class="nf">torch_jit_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">torch</span>

        <span class="n">traced</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span><span class="p">):</span>
            <span class="n">traced</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span>
            <span class="k">return</span> <span class="n">path</span>

        <span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>

        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tfile</span><span class="p">:</span>
            <span class="n">traced</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">):</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upload_s3</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">path</span>

            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upload_gs</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">path</span>

            <span class="n">target_path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tries</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">target_path</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">path</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="n">backup</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tries</span><span class="si">}</span><span class="s2"> left, saving to </span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2"> again. Backup for </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> sec...&quot;</span><span class="p">)</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.load_file"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; return the binary stream, most versatile.</span>

<span class="sd">        todo: check handling of line-separated files</span>

<span class="sd">        when key starts with a single slash as in &quot;/debug/some-run&quot;, the leading slash is removed</span>
<span class="sd">        and the remaining path is pathJoin&#39;ed with the data_dir of the server.</span>

<span class="sd">        So if you want to access absolute path of the filesystem that the logging server is in,</span>
<span class="sd">        you should append two leadning slashes. This way, when the leanding slash is removed,</span>
<span class="sd">        the remaining path is still an absolute value and joining with the data_dir would post</span>
<span class="sd">        no effect.</span>

<span class="sd">        &quot;//home/ubuntu/ins-runs/debug/some-other-run&quot; would point to the system absolute path.</span>

<span class="sd">        :param *keys: path string fragments that are joined together</span>
<span class="sd">        :return: a tuple of each one of the data chunck logged into the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">stream_download</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.download_file"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.download_file">[docs]</a>    <span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is not found in the logging server.&quot;</span><span class="p">)</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">to</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">to</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># use absolute path to make sure the parent directory exists.</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">to</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getbuffer</span><span class="p">())</span></div>

<div class="viewcode-block" id="ML_Dash.load_torch"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_torch">[docs]</a>    <span class="k">def</span> <span class="nf">load_torch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">tempfile</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">7</span><span class="p">:],</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">):</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ntp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_s3</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">to</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ntp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_gs</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">to</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_or_buff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fn_or_buff</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="n">torch_load</span> <span class="o">=</span> <span class="n">load_torch</span>

<div class="viewcode-block" id="ML_Dash.torch_jit_load"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.torch_jit_load">[docs]</a>    <span class="k">def</span> <span class="nf">torch_jit_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">tempfile</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">7</span><span class="p">:],</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">):</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ntp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_s3</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">to</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ntp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_gs</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">to</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_or_buff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fn_or_buff</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.load_pkl"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_pkl">[docs]</a>    <span class="k">def</span> <span class="nf">load_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load a pkl file *as a tuple*. By default, each file would contain 1 data item.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            data, = logger.load_pkl(&quot;episodeyang/weights.pkl&quot;)</span>

<span class="sd">        You could also load a particular data chunk by index:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            data_chunks = logger.load_pkl(&quot;episodeyang/weights.pkl&quot;, start=10)</span>


<span class="sd">        when key starts with a single slash as in &quot;/debug/some-run&quot;, the leading slash is removed</span>
<span class="sd">        and the remaining path is pathJoin&#39;ed with the data_dir of the server.</span>

<span class="sd">        So if you want to access absolute path of the filesystem that the logging server is in,</span>
<span class="sd">        you should append two leadning slashes. This way, when the leanding slash is removed,</span>
<span class="sd">        the remaining path is still an absolute value and joining with the data_dir would post</span>
<span class="sd">        no effect.</span>

<span class="sd">        &quot;//home/ubuntu/ins-runs/debug/some-other-run&quot; would point to the system absolute path.</span>

<span class="sd">        Because loading is usually synchronous, we can encounter connection errors. We don&#39;t want</span>
<span class="sd">        to halt our training session b/c of these errors without retrying a few times.</span>

<span class="sd">        For this reason, `logger.load_pkl` (and `iload_pkl` to equal measure) both takes a `tries`</span>
<span class="sd">        argument and a `delay` argument. The delay argument is multipled by a random number,</span>
<span class="sd">        to avoid synchronized DDoS attach on your instrumentation server.</span>


<span class="sd">        tries</span>

<span class="sd">        :param *keys: path string fragments</span>
<span class="sd">        :param start: Starting index for the chunks None means from the beginning.</span>
<span class="sd">        :param stop: Stop index for the chunks. None means to the end of the file.</span>
<span class="sd">        :param tries: (int) The number of ties for the request. The last one does not catch error.</span>
<span class="sd">        :param delay: (float) the delay multiplier between the retries. Multiplied (in seconds) with</span>
<span class="sd">            a random float in [1, 1.5).</span>
<span class="sd">        :return: a tuple of each one of the data chunck logged into the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>

        <span class="c1"># Added s3/gs support</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_from_pickle_file</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">7</span><span class="p">:]))</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">):</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ntp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_s3</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">to</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">ntp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_from_pickle_file</span><span class="p">(</span><span class="n">ntp</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ntp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_gs</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">to</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">ntp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_from_pickle_file</span><span class="p">(</span><span class="n">ntp</span><span class="p">))</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                    <span class="n">blobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">blobs</span><span class="p">:</span>
                        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_from_pickle_file</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">random</span>
                <span class="c1"># todo: use separate random generator to avoid mutating global random generator.</span>
                <span class="n">sleep</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">delay</span><span class="p">)</span>
                <span class="n">tries</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="c1"># last one does not catch.</span>
        <span class="k">with</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_from_pickle_file</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span></div>

<div class="viewcode-block" id="ML_Dash.iload_pkl"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.iload_pkl">[docs]</a>    <span class="k">def</span> <span class="nf">iload_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load a pkl file as *an iterator*.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            for chunk in logger.iload_pkl(&quot;episodeyang/weights.pkl&quot;)</span>
<span class="sd">                print(chunk)</span>

<span class="sd">         or alternatively just read a single data file:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            data, = logger.iload_pkl(&quot;episodeyang/weights.pkl&quot;)</span>

<span class="sd">        when key starts with a single slash as in &quot;/debug/some-run&quot;, the leading slash is removed</span>
<span class="sd">        and the remaining path is pathJoin&#39;ed with the data_dir of the server.</span>

<span class="sd">        So if you want to access absolute path of the filesystem that the logging server is in,</span>
<span class="sd">        you should append two leadning slashes. This way, when the leanding slash is removed,</span>
<span class="sd">        the remaining path is still an absolute value and joining with the data_dir would post</span>
<span class="sd">        no effect.</span>

<span class="sd">        &quot;//home/ubuntu/ins-runs/debug/some-other-run&quot; would point to the system absolute path.</span>

<span class="sd">        :param key: path string.</span>
<span class="sd">        :param start: Starting index for the chunks None means from the beginning.</span>
<span class="sd">        :param stop: Stop index for the chunks. None means to the end of the file.</span>
<span class="sd">        :param tries: (int) The number of ties for the request. The last one does not catch error.</span>
<span class="sd">        :param delay: (float) the delay multiplier between the retries. Multiplied (in seconds) with</span>
<span class="sd">            a random float in [0, 1).</span>
<span class="sd">        :return: a iterator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunks</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">yield from</span> <span class="n">chunks</span></div>

<div class="viewcode-block" id="ML_Dash.load_np"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_np">[docs]</a>    <span class="k">def</span> <span class="nf">load_np</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; load a np file</span>

<span class="sd">        when key starts with a single slash as in &quot;/debug/some-run&quot;, the leading slash is removed</span>
<span class="sd">        and the remaining path is pathJoin&#39;ed with the data_dir of the server.</span>

<span class="sd">        So if you want to access absolute path of the filesystem that the logging server is in,</span>
<span class="sd">        you should append two leadning slashes. This way, when the leanding slash is removed,</span>
<span class="sd">        the remaining path is still an absolute value and joining with the data_dir would post</span>
<span class="sd">        no effect.</span>

<span class="sd">        &quot;//home/ubuntu/ins-runs/debug/some-other-run&quot; would point to the system absolute path.</span>

<span class="sd">        :param keys: path strings</span>
<span class="sd">        :return: a tuple of each one of the data chunck logged into the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_np</span><span class="p">(</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">))</span></div>

<div class="viewcode-block" id="ML_Dash.load_json"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_json">[docs]</a>    <span class="k">def</span> <span class="nf">load_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">))</span></div>

<div class="viewcode-block" id="ML_Dash.load_csv"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_csv">[docs]</a>    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
        <span class="n">csv_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">csv_str</span><span class="p">))</span></div>

<div class="viewcode-block" id="ML_Dash.load_yaml"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">load_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">yaml</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span> <span class="ow">or</span> <span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.load_h5"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.load_h5">[docs]</a>    <span class="k">def</span> <span class="nf">load_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">read_h5</span><span class="p">(</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">))</span></div>

<div class="viewcode-block" id="ML_Dash.plt2data"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.plt2data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plt2data</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        @brief Convert a Matplotlib figure to a 4D numpy array with RGBA channels and return it</span>
<span class="sd">        @param fig a matplotlib figure</span>
<span class="sd">        @return a numpy 3D array of RGBA values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># draw the renderer</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>  <span class="c1"># need this if &#39;transparent=True&#39; to reset colors</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="c1"># Get the RGBA buffer from the figure</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_width_height</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">tostring_rgb</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># todo: use alpha RGB instead</span>
        <span class="c1"># buf.shape = (h, w, 4)</span>
        <span class="c1"># canvas.tostring_argb give pixmap in ARGB mode. Roll the ALPHA channel to have it in RGBA mode</span>
        <span class="c1"># buf = np.roll(buf, 4, axis=2)</span>
        <span class="k">return</span> <span class="n">buf</span></div>

<div class="viewcode-block" id="ML_Dash.save_json"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_json">[docs]</a>    <span class="k">def</span> <span class="nf">save_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">json</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.save_yaml"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">save_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">yaml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_text</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.save_h5"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.save_h5">[docs]</a>    <span class="k">def</span> <span class="nf">save_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># todo: make buffer is keyed by file name</span>
    <span class="c1"># todo: add option to save non-colored logs.</span>
<div class="viewcode-block" id="ML_Dash.log_line"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log_line">[docs]</a>    <span class="k">def</span> <span class="nf">log_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this is similar to the print function. It logs *args with a default EOL postfix in the end.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            n = 10</span>
<span class="sd">            logger.log_line(&quot;Mary&quot;, &quot;has&quot;, n, &quot;sheep.&quot;, color=&quot;green&quot;)</span>

<span class="sd">        This outputs:</span>

<span class="sd">        ::</span>

<span class="sd">            &gt;&gt;&gt; &quot;Mary has 10 sheep&quot; (colored green)</span>

<span class="sd">        :param *args: List of object to be converted to string and printed out.</span>
<span class="sd">        :param sep: Same as the `sep` kwarg in regular print statements</span>
<span class="sd">        :param end: Same as the `end` kwarg in regular print statements</span>
<span class="sd">        :param flush: bool, whether the output is flushed. Default to True</span>
<span class="sd">        :param file: file object to which the line is written</span>
<span class="sd">        :param color: str, color of the line. We use `termcolor.colored` as our color library. See list of</span>
<span class="sd">            colors here: _`termcolor`: https://pypi.org/project/termcolor/</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span> <span class="o">+</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_buffer</span> <span class="o">+=</span> <span class="n">text</span>
        <span class="c1"># todo: print_buffer is not keyed by file. This is a bug.</span>
        <span class="k">if</span> <span class="n">flush</span> <span class="ow">or</span> <span class="n">file</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">print_buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_buffer_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_print_buffer</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.log_jsonl"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log_jsonl">[docs]</a>    <span class="k">def</span> <span class="nf">log_jsonl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">json</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">serialized</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_line</span><span class="p">(</span><span class="n">serialized</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.print"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.print">[docs]</a>    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dedent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">dedent</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">textwrap</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">colored</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_line</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.pprint"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.pprint">[docs]</a>    <span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">depth</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.flush_print_buffer"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.flush_print_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">flush_print_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_buffer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">print_buffer</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_buffer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="ML_Dash.log_text"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.log_text">[docs]</a>    <span class="k">def</span> <span class="nf">log_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dedent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        logging and printing a string object.</span>

<span class="sd">        This does not log to the buffer. It calls the low-level log_text method right away</span>
<span class="sd">        without buffering.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            logger.log_text(&#39;&#39;&#39;</span>
<span class="sd">                some text</span>
<span class="sd">                with indent&#39;&#39;&#39;, dedent=True)</span>

<span class="sd">        This logs with out the indentation at the begining of the text.</span>

<span class="sd">        :param text:</span>
<span class="sd">        :param filename: file name to which the string is logged.</span>
<span class="sd">        :param dedent: boolean flag for dedenting the multi-line string</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_filename</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dedent</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">textwrap</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_text</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.glob"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.glob">[docs]</a>    <span class="k">def</span> <span class="nf">glob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Globs files under the work directory (`wd`). Note that `wd` affects the file paths</span>
<span class="sd">        being returned. The default is the current logging prefix. Use absolute path (with</span>
<span class="sd">        a leading slash (`/`) to escape the logging prefix. Use two leading slashes for</span>
<span class="sd">        the absolute path in the host for the logging server.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            with logger.PrefixContext(&quot;&lt;your-run-prefix&gt;&quot;):</span>
<span class="sd">                runs = logger.glob(&#39;**/metrics.pkl&#39;)</span>
<span class="sd">                for _ in runs:</span>
<span class="sd">                    exp_log = logger.load_pkl(_)</span>

<span class="sd">        :param query:</span>
<span class="sd">        :param wd: defaults to the current prefix. When trueful values are given, uses:</span>
<span class="sd">            &gt; wd = pJoin(self.prefix, wd)</span>

<span class="sd">            if you want root of the logging server instance, use abs path headed by `/`.</span>
<span class="sd">            If you want root of the server file system, double slash: `//home/directory-name-blah`.</span>

<span class="sd">        :param recursive:</span>
<span class="sd">        :param start:</span>
<span class="sd">        :param stop:</span>
<span class="sd">        :return: None if the director does not exist (internal FileNotFoundError)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wd</span> <span class="ow">and</span> <span class="n">query</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">)]</span>

        <span class="n">wd</span> <span class="o">=</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">wd</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.get_exps"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.get_exps">[docs]</a>    <span class="k">def</span> <span class="nf">get_exps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">prefixes</span><span class="p">,</span> <span class="n">as_dataframe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
        <span class="kn">from</span> <span class="nn">ml_dash.helpers.func_helpers</span> <span class="kn">import</span> <span class="n">assign</span><span class="p">,</span> <span class="n">dot_flatten</span>
        <span class="n">all_prefixes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">prefixes</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;glob&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">show_progress</span> <span class="k">else</span> <span class="n">prefixes</span><span class="p">:</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">path</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;parameters.pkl&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">pJoin</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;parameters.pkl&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">full_path</span><span class="p">:</span>
                <span class="n">all_prefixes</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_prefixes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">full_path</span><span class="p">]</span>

        <span class="n">all_exp_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exp_prefix</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">all_prefixes</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;loading&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">show_progress</span> <span class="k">else</span> <span class="n">all_exps</span><span class="p">:</span>
            <span class="n">params_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="n">exp_prefix</span><span class="p">)</span>
            <span class="n">params_dict</span> <span class="o">=</span> <span class="n">dot_flatten</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">params_data</span><span class="p">))</span>
            <span class="n">params_dict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_prefix</span>
            <span class="n">all_exp_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">as_dataframe</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_exp_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_exp_params</span></div>

<div class="viewcode-block" id="ML_Dash.get_parameters"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.get_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;parameters.pkl&quot;</span><span class="p">,</span> <span class="n">not_exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        utility to obtain the hyperparameters as a flattened dictionary.</span>

<span class="sd">        1. returns a dot-flattened dictionary if no keys are passed.</span>
<span class="sd">        2. returns a single value if only one key is passed.</span>
<span class="sd">        3. returns a list of values if multiple keys are passed.</span>

<span class="sd">        If keys are passed, returns an array with each item corresponding to those keys</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            lr, global_metric = logger.get_parameters(&#39;Args.lr&#39;, &#39;Args.global_metric&#39;)</span>
<span class="sd">            print(lr, global_metric)</span>

<span class="sd">        this returns:</span>

<span class="sd">        .. code:: bash</span>

<span class="sd">            0.03 &#39;ResNet18L2&#39;</span>

<span class="sd">        Raises `FileNotFound` error if the parameter file pointed by the path is empty. To</span>
<span class="sd">        avoid this, add a `default` keyword value to the call:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            param = logger.get_parameter(&#39;does_not_exist&#39;, default=None)</span>
<span class="sd">            assert param is None, &quot;should be the default value: None&quot;</span>


<span class="sd">        :param *keys: A list of strings to specify the parameter keys</span>
<span class="sd">        :param silent: bool, prevents raising an exception.</span>
<span class="sd">        :param path: Path to the parameters.pkl file. Keyword argument, default to `parameters.pkl`.</span>
<span class="sd">        :param default: Undefined. If the default key is present, return default when param is missing.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">else</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="ow">and</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;parameters.pkl&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Your last key looks like a `parameters.pkl` path. Make &#39;</span>
                           <span class="s1">&#39;sure you use a keyword argument to specify the path!&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">not_exist_ok</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the parameter file is not found at &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
        <span class="kn">from</span> <span class="nn">ml_dash.helpers.func_helpers</span> <span class="kn">import</span> <span class="n">assign</span><span class="p">,</span> <span class="n">dot_flatten</span>
        <span class="n">parameter_dict</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">assign</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">if</span> <span class="n">_</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">dot_flatten</span><span class="p">(</span><span class="n">parameter_dict</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameter_dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> does not exist in </span><span class="si">{</span><span class="n">parameters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># info: cast to tuple, so that we can use this as a key in dict directly.</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_value</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_value</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parameters</span></div>

    <span class="n">read_params</span> <span class="o">=</span> <span class="n">get_parameters</span>

<div class="viewcode-block" id="ML_Dash.read_metrics"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.read_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">read_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">x_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;metrics.pkl&quot;</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a Pandas.DataFrame object that contains metrics from all files.</span>

<span class="sd">        :param dropna: if True, drop NaN values.</span>
<span class="sd">        :param keys: if non passed, returns the entire dataframe. If 1 key is passed,</span>
<span class="sd">                     return that column. If multiple keys are passed, return  individual columns.</span>

<span class="sd">                     If you want to get the joined table for multiple keys, directly filter after</span>
<span class="sd">                     this call.</span>

<span class="sd">        :param num_bins: the number of bins</span>
<span class="sd">        :param bin_size: the size of each bin</span>
<span class="sd">        :param path: can contain glob patterns, will return concatenated dataframe from</span>
<span class="sd">                     all paths found with the pattern.</span>
<span class="sd">        :param silent: silent the</span>
<span class="sd">        :param default: Default value for columns. Not widely used.</span>
<span class="sd">        :return: pandas.DataFrame or None when no metric file is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ExitStack</span>

        <span class="k">if</span> <span class="n">x_key</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="n">x_key</span><span class="p">]</span>
            <span class="n">x_key</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">x_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">meta_keys</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">aggs</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
                <span class="n">meta_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aggs</span><span class="p">)</span>

            <span class="n">keys</span><span class="p">,</span> <span class="n">query_keys</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">meta_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span> <span class="n">keys</span>

        <span class="c1"># todo: remove default from this.</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">else</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">all_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">PrefixContext</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span> <span class="k">if</span> <span class="n">wd</span> <span class="k">else</span> <span class="n">ExitStack</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jsonl&quot;</span><span class="p">):</span>
                    <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_jsonl</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                    <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># if path.endswith(&quot;.pkl&quot;):</span>
                    <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_pkl</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keys</span> <span class="ow">and</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="s2">&quot;.pkl&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span>
                        <span class="s2">&quot;.jsonl&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span>
                        <span class="s2">&quot;.csv&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_line</span><span class="p">(</span><span class="s1">&#39;Your last key looks like a `metrics.pkl` path. Make &#39;</span>
                                  <span class="s1">&#39;sure you use a keyword argument to specify the path!&#39;</span><span class="p">,</span>
                                  <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fails to load metric file at </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">metrics</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">. Contains </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">x_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num_bins</span><span class="p">:</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x_key</span><span class="p">],</span> <span class="n">num_bins</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bin_size</span> <span class="o">=</span> <span class="n">bin_size</span> <span class="ow">or</span> <span class="mi">1</span>
                    <span class="kn">import</span> <span class="nn">math</span>
                    <span class="n">num_bins</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x_key</span><span class="p">],</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>

                <span class="n">new_df</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">x_key</span><span class="p">:</span>
                        <span class="n">new_df</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">new_df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">all_metrics</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_metrics</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">x_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">x_key</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">x_key</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">num_bins</span><span class="p">:</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x_key</span><span class="p">],</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bin_size</span><span class="p">:</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x_key</span><span class="p">],</span> <span class="n">bin_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">aggs</span> <span class="ow">in</span> <span class="n">meta_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">items</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
            <span class="n">new_df</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;@median&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">reduce</span> <span class="ow">in</span> <span class="n">aggs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reduce</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
                    <span class="n">pc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">reduce</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">new_df</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">reduce</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">pc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_df</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">reduce</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">reduce</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># apply bin, min@x, mean@y, etc.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">default</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">query_keys</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">default</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metrics</span></div>

    <span class="n">get_dataframe</span> <span class="o">=</span> <span class="n">read_metrics</span>

<div class="viewcode-block" id="ML_Dash.abspath"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.abspath">[docs]</a>    <span class="k">def</span> <span class="nf">abspath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the absolute path w.r.t the logging directory.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            print(logger.abspath(&quot;some&quot;, &quot;path&quot;))</span>

<span class="sd">            # /home/ge/some/path</span>


<span class="sd">        :param *paths: position arguments for each segment of the path.</span>
<span class="sd">        :return: absolute path w.r.t. the logging directory (excluding the prefix)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">pJoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span></div>

<div class="viewcode-block" id="ML_Dash.capture_error"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.capture_error">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">capture_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;error.log&quot;</span><span class="p">,</span> <span class="n">reraise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">logger</span><span class="o">.</span><span class="n">SyncContext</span><span class="p">():</span>  <span class="c1"># Make sure uploaded finished before termination.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Exception occurred&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reraise</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="ML_Dash.clone"><a class="viewcode-back" href="../../api/ml_dash.html#ml_dash.ML_Dash.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;deep copy the entire logger object.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<span class="n">logger</span> <span class="o">=</span> <span class="n">ML_Dash</span><span class="p">()</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Ge Yang
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/fortyfive-labs/ml-dash" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    </body>
</html>